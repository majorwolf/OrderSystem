<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Restaurant Order System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Sidebar -->
        <div class="fixed inset-y-0 left-0 w-64 bg-gray-800 text-white">
            <div class="p-4">
                <h1 class="text-2xl font-bold">Admin Panel</h1>
            </div>
            <nav class="mt-4">
                <a href="#" class="block py-2 px-4 hover:bg-gray-700" onclick="showSection('menu')">
                    <i class="fas fa-utensils mr-2"></i>Menu Items
                </a>
                <a href="#" class="block py-2 px-4 hover:bg-gray-700" onclick="showSection('tables')">
                    <i class="fas fa-chair mr-2"></i>Tables
                </a>
                <a href="#" class="block py-2 px-4 hover:bg-gray-700" onclick="showSection('reservations')">
                    <i class="fas fa-calendar-alt mr-2"></i>Reservations
                </a>
                <a href="#" class="block py-2 px-4 hover:bg-gray-700" onclick="showSection('toppings')">
                    <i class="fas fa-plus-circle mr-2"></i>Toppings
                </a>
                <a href="#" class="block py-2 px-4 hover:bg-gray-700" onclick="showSection('orders')">
                    <i class="fas fa-clipboard-list mr-2"></i>Orders
                </a>
                <a href="#" class="block py-2 px-4 hover:bg-gray-700" onclick="showSection('stats')">
                    <i class="fas fa-chart-bar mr-2"></i>Statistics
                </a>
                <a href="#" class="block py-2 px-4 hover:bg-gray-700" onclick="showSection('users')">
                    <i class="fas fa-users mr-2"></i>Admin Users
                </a>
                <a href="#" class="block py-2 px-4 hover:bg-gray-700" onclick="logout()">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="ml-64 p-8">
            <!-- Menu Items Section -->
            <div id="menu-section" class="section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Menu Items</h2>
                    <div class="flex space-x-4">
                        <select id="menuCategoryFilter" onchange="loadMenuItems()" class="rounded-md border-gray-300 shadow-sm">
                            <option value="">All Categories</option>
                            <option value="pizza">Pizza</option>
                            <option value="kitchen">Kitchen</option>
                            <option value="bar">Bar</option>
                        </select>
                        <button onclick="showAddMenuItemModal()" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i>Add Menu Item
                        </button>
                    </div>
                </div>
                <div id="menu-items-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Menu items will be loaded here -->
                </div>
            </div>

            <!-- Tables Section -->
            <div id="tables-section" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Tables</h2>
                    <button onclick="showAddTableModal()" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>Add Table
                    </button>
                </div>
                <div id="tables-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Tables will be loaded here -->
                </div>
            </div>

            <!-- Toppings Section -->
            <div id="toppings-section" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Toppings</h2>
                    <button onclick="showAddToppingModal()" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>Add Topping
                    </button>
                </div>
                <div id="toppings-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Toppings will be loaded here -->
                </div>
            </div>

            <!-- Reservations Section -->
            <div id="reservations-section" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Table Reservations</h2>
                    <button onclick="showAddReservationModal()" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>Add Reservation
                    </button>
                </div>
                <div id="reservations-list" class="space-y-4">
                    <!-- Reservations will be loaded here -->
                </div>
            </div>

            <!-- Admin Users Section -->
            <div id="users-section" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Admin Users</h2>
                    <button onclick="showAddAdminUserModal()" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>Add Admin User
                    </button>
                </div>
                <div id="admin-users-list" class="space-y-4">
                    <!-- Admin users will be loaded here -->
                </div>
            </div>

            <!-- Orders Section -->
            <div id="orders-section" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Active Orders</h2>
                    <div class="flex space-x-4">
                        <div class="flex items-center">
                            <label class="mr-2">Start Date:</label>
                            <input type="date" id="orderStartDate" class="rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div class="flex items-center">
                            <label class="mr-2">End Date:</label>
                            <input type="date" id="orderEndDate" class="rounded-md border-gray-300 shadow-sm">
                        </div>
                        <button onclick="loadOrders()" class="btn btn-primary">
                            <i class="fas fa-filter mr-2"></i>Filter
                        </button>
                    </div>
                </div>
                <div id="orders-list" class="space-y-4">
                    <!-- Orders will be loaded here -->
                </div>
            </div>

            <!-- Statistics Section -->
            <div id="stats-section" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Order Statistics</h2>
                    <div class="flex space-x-4">
                        <div class="flex items-center">
                            <label class="mr-2">Start Date:</label>
                            <input type="date" id="statsStartDate" class="rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div class="flex items-center">
                            <label class="mr-2">End Date:</label>
                            <input type="date" id="statsEndDate" class="rounded-md border-gray-300 shadow-sm">
                        </div>
                        <button onclick="loadOrderStats()" class="btn btn-primary">
                            <i class="fas fa-filter mr-2"></i>Filter
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-600">Total Orders</h3>
                        <p id="totalOrders" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-600">Total Revenue</h3>
                        <p id="totalRevenue" class="text-3xl font-bold text-green-600">$0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-600">Average Order Value</h3>
                        <p id="avgOrderValue" class="text-3xl font-bold text-purple-600">$0.00</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-600 mb-4">Top Menu Items</h3>
                        <div id="topMenuItems" class="space-y-2">
                            <!-- Top menu items will be loaded here -->
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-600 mb-4">Busiest Hours</h3>
                        <div id="busiestHours" class="space-y-2">
                            <!-- Busiest hours will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modals-container"></div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';

        // Utility functions
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`${sectionId}-section`).classList.remove('hidden');
        }

        function createModal(title, content, onClose) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg w-96">
                    <h3 class="text-lg font-semibold mb-4">${title}</h3>
                    ${content}
                    <div class="mt-4 flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="btn btn-secondary">Close</button>
                    </div>
                </div>
            `;
            document.getElementById('modals-container').appendChild(modal);
            return modal;
        }

        // Menu Items Management
        async function loadMenuItems() {
            try {
                const category = document.getElementById('menuCategoryFilter').value;
                let url = `${API_BASE_URL}/admin/menu`;
                if (category) {
                    url += `?category=${category}`;
                }
                
                const response = await fetch(url);
                const items = await response.json();
                const container = document.getElementById('menu-items-list');
                container.innerHTML = items.map(item => `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold">${item.name}</h3>
                        <p class="text-gray-600">${item.description}</p>
                        <p class="text-green-600 font-bold">$${item.price.toFixed(2)}</p>
                        <p class="text-sm text-gray-500">Category: ${item.type}</p>
                        <div class="mt-2 flex items-center">
                            <span class="mr-2">Available:</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" 
                                       ${item.is_available ? 'checked' : ''}
                                       onchange="toggleMenuItemAvailability(${item.id}, this.checked)">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="mt-2 flex space-x-2">
                            <button onclick="showEditMenuItemModal(${item.id})" class="btn btn-secondary">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="manageMenuItemToppings(${item.id})" class="btn btn-secondary">
                                <i class="fas fa-list"></i>
                            </button>
                            <button onclick="deleteMenuItem(${item.id})" class="btn btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading menu items:', error);
                alert('Failed to load menu items. Please try again.');
            }
        }

        async function manageMenuItemToppings(itemId) {
            try {
                const [itemResponse, toppingsResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/admin/menu/${itemId}/toppings`),
                    fetch(`${API_BASE_URL}/admin/toppings`)
                ]);
                
                const item = await itemResponse.json();
                const allToppings = await toppingsResponse.json();
                
                const modal = createModal(
                    `Manage Toppings for ${item.name}`,
                    `
                    <div class="space-y-2">
                        ${allToppings.map(topping => `
                            <label class="flex items-center">
                                <input type="checkbox" 
                                       class="mr-2" 
                                       ${item.toppings.some(t => t.id === topping.id) ? 'checked' : ''}
                                       onchange="toggleMenuItemTopping(${itemId}, ${topping.id}, this.checked)">
                                <span>${topping.name} ($${topping.price.toFixed(2)})</span>
                            </label>
                        `).join('')}
                    </div>
                    `
                );
            } catch (error) {
                console.error('Error managing menu item toppings:', error);
                alert('Failed to load toppings. Please try again.');
            }
        }

        async function toggleMenuItemTopping(itemId, toppingId, isSelected) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/menu/${itemId}/toppings/${toppingId}`, {
                    method: isSelected ? 'POST' : 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to update menu item toppings');
                }
            } catch (error) {
                console.error('Error updating menu item toppings:', error);
                alert('Failed to update toppings. Please try again.');
            }
        }

        function showAddMenuItemModal() {
            const modal = createModal(
                'Add New Menu Item',
                `
                <form onsubmit="handleAddMenuItem(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Type</label>
                        <select name="type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="pizza">Pizza</option>
                            <option value="kitchen">Kitchen</option>
                            <option value="bar">Bar</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" name="price" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea name="description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Add Menu Item</button>
                </form>
                `
            );
        }

        async function showEditMenuItemModal(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/menu/${id}`);
                const item = await response.json();
                
                const modal = createModal(
                    'Edit Menu Item',
                    `
                    <form onsubmit="handleEditMenuItem(event, ${id})" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" name="name" value="${item.name}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Type</label>
                            <select name="type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option value="pizza" ${item.type === 'pizza' ? 'selected' : ''}>Pizza</option>
                                <option value="kitchen" ${item.type === 'kitchen' ? 'selected' : ''}>Kitchen</option>
                                <option value="bar" ${item.type === 'bar' ? 'selected' : ''}>Bar</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Price</label>
                            <input type="number" name="price" value="${item.price}" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea name="description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${item.description || ''}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Update Menu Item</button>
                    </form>
                    `
                );
            } catch (error) {
                console.error('Error loading menu item:', error);
                alert('Failed to load menu item. Please try again.');
            }
        }

        async function handleAddMenuItem(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/menu`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        type: formData.get('type'),
                        price: parseFloat(formData.get('price')),
                        description: formData.get('description')
                    }),
                });

                if (response.ok) {
                    event.target.closest('.fixed').remove();
                    loadMenuItems();
                } else {
                    throw new Error('Failed to add menu item');
                }
            } catch (error) {
                console.error('Error adding menu item:', error);
                alert('Failed to add menu item. Please try again.');
            }
        }

        async function handleEditMenuItem(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/menu/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        type: formData.get('type'),
                        price: parseFloat(formData.get('price')),
                        description: formData.get('description')
                    }),
                });

                if (response.ok) {
                    event.target.closest('.fixed').remove();
                    loadMenuItems();
                } else {
                    throw new Error('Failed to update menu item');
                }
            } catch (error) {
                console.error('Error updating menu item:', error);
                alert('Failed to update menu item. Please try again.');
            }
        }

        // Tables Management
        async function loadTables() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/tables`);
                const tables = await response.json();
                const container = document.getElementById('tables-list');
                container.innerHTML = tables.map(table => `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold">Table ${table.number}</h3>
                        <p class="text-gray-600">Capacity: ${table.capacity}</p>
                        <p class="text-gray-600">Status: ${table.status}</p>
                        <div class="mt-2">
                            <button onclick="generateQRCode(${table.id})" class="btn btn-secondary mb-2">
                                <i class="fas fa-qrcode mr-2"></i>Generate QR Code
                            </button>
                        </div>
                        <div class="mt-2 flex space-x-2">
                            <button onclick="showEditTableModal(${table.id})" class="btn btn-secondary">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTable(${table.id})" class="btn btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading tables:', error);
                alert('Failed to load tables. Please try again.');
            }
        }

        function showAddTableModal() {
            const modal = createModal(
                'Add New Table',
                `
                <form onsubmit="handleAddTable(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Table Number</label>
                        <input type="number" name="number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Capacity</label>
                        <input type="number" name="capacity" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Status</label>
                        <select name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="available">Available</option>
                            <option value="occupied">Occupied</option>
                            <option value="reserved">Reserved</option>
                            <option value="maintenance">Maintenance</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Add Table</button>
                </form>
                `
            );
        }

        async function handleAddTable(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/tables`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        number: parseInt(formData.get('number')),
                        capacity: parseInt(formData.get('capacity')),
                        status: formData.get('status')
                    }),
                });

                if (response.ok) {
                    event.target.closest('.fixed').remove();
                    loadTables();
                } else {
                    throw new Error('Failed to add table');
                }
            } catch (error) {
                console.error('Error adding table:', error);
                alert('Failed to add table. Please try again.');
            }
        }

        async function showEditTableModal(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/tables/${id}`);
                const table = await response.json();
                
                const modal = createModal(
                    'Edit Table',
                    `
                    <form onsubmit="handleEditTable(event, ${id})" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Table Number</label>
                            <input type="number" name="number" value="${table.number}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Capacity</label>
                            <input type="number" name="capacity" value="${table.capacity}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Status</label>
                            <select name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option value="available" ${table.status === 'available' ? 'selected' : ''}>Available</option>
                                <option value="occupied" ${table.status === 'occupied' ? 'selected' : ''}>Occupied</option>
                                <option value="reserved" ${table.status === 'reserved' ? 'selected' : ''}>Reserved</option>
                                <option value="maintenance" ${table.status === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Update Table</button>
                    </form>
                    `
                );
            } catch (error) {
                console.error('Error loading table:', error);
                alert('Failed to load table. Please try again.');
            }
        }

        async function handleEditTable(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/tables/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        number: parseInt(formData.get('number')),
                        capacity: parseInt(formData.get('capacity')),
                        status: formData.get('status')
                    }),
                });

                if (response.ok) {
                    event.target.closest('.fixed').remove();
                    loadTables();
                } else {
                    throw new Error('Failed to update table');
                }
            } catch (error) {
                console.error('Error updating table:', error);
                alert('Failed to update table. Please try again.');
            }
        }

        // Toppings Management
        async function loadToppings() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/toppings`);
                const toppings = await response.json();
                const container = document.getElementById('toppings-list');
                container.innerHTML = toppings.map(topping => `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold">${topping.name}</h3>
                        <p class="text-green-600 font-bold">$${topping.price.toFixed(2)}</p>
                        <div class="mt-2 flex space-x-2">
                            <button onclick="showEditToppingModal(${topping.id})" class="btn btn-secondary">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTopping(${topping.id})" class="btn btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading toppings:', error);
                alert('Failed to load toppings. Please try again.');
            }
        }

        function showAddToppingModal() {
            const modal = createModal(
                'Add New Topping',
                `
                <form onsubmit="handleAddTopping(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" name="price" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Add Topping</button>
                </form>
                `
            );
        }

        async function handleAddTopping(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/toppings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        price: parseFloat(formData.get('price'))
                    }),
                });

                if (response.ok) {
                    event.target.closest('.fixed').remove();
                    loadToppings();
                } else {
                    throw new Error('Failed to add topping');
                }
            } catch (error) {
                console.error('Error adding topping:', error);
                alert('Failed to add topping. Please try again.');
            }
        }

        async function showEditToppingModal(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/toppings/${id}`);
                const topping = await response.json();
                
                const modal = createModal(
                    'Edit Topping',
                    `
                    <form onsubmit="handleEditTopping(event, ${id})" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" name="name" value="${topping.name}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Price</label>
                            <input type="number" name="price" value="${topping.price}" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Update Topping</button>
                    </form>
                    `
                );
            } catch (error) {
                console.error('Error loading topping:', error);
                alert('Failed to load topping. Please try again.');
            }
        }

        async function handleEditTopping(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/toppings/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        price: parseFloat(formData.get('price'))
                    }),
                });

                if (response.ok) {
                    event.target.closest('.fixed').remove();
                    loadToppings();
                } else {
                    throw new Error('Failed to update topping');
                }
            } catch (error) {
                console.error('Error updating topping:', error);
                alert('Failed to update topping. Please try again.');
            }
        }

        // Delete functions
        async function deleteMenuItem(id) {
            if (!confirm('Are you sure you want to delete this menu item?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/menu/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadMenuItems();
                } else {
                    throw new Error('Failed to delete menu item');
                }
            } catch (error) {
                console.error('Error deleting menu item:', error);
                alert('Failed to delete menu item. Please try again.');
            }
        }

        async function deleteTable(id) {
            if (!confirm('Are you sure you want to delete this table?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/tables/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadTables();
                } else {
                    throw new Error('Failed to delete table');
                }
            } catch (error) {
                console.error('Error deleting table:', error);
                alert('Failed to delete table. Please try again.');
            }
        }

        async function deleteTopping(id) {
            if (!confirm('Are you sure you want to delete this topping?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/toppings/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadToppings();
                } else {
                    throw new Error('Failed to delete topping');
                }
            } catch (error) {
                console.error('Error deleting topping:', error);
                alert('Failed to delete topping. Please try again.');
            }
        }

        // Order Management
        async function loadOrders() {
            try {
                const startDate = document.getElementById('orderStartDate').value;
                const endDate = document.getElementById('orderEndDate').value;
                let url = `${API_BASE_URL}/admin/orders`;
                
                if (startDate || endDate) {
                    url += `/history?start_date=${startDate}&end_date=${endDate}`;
                }
                
                const response = await fetch(url);
                const orders = await response.json();
                const container = document.getElementById('orders-list');
                
                container.innerHTML = orders.map(order => `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-semibold">Order #${order.id}</h3>
                                <p class="text-gray-600">Table ${order.table_id}</p>
                                <p class="text-gray-600">Customer: ${order.last_name}</p>
                                <p class="text-gray-600">Created: ${new Date(order.created_at).toLocaleString()}</p>
                                <p class="text-gray-600">Payment Status: ${order.payment_status}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-green-600 font-bold">$${order.items.reduce((sum, item) => sum + item.price, 0).toFixed(2)}</p>
                                ${order.payment_status === 'pending' ? `
                                    <button onclick="completeOrder(${order.id})" class="btn btn-primary mt-2">
                                        Complete Order
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-medium mb-2">Items:</h4>
                            <div class="space-y-2">
                                ${order.items.map(item => `
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-medium">${item.menu_item.name}</p>
                                            <p class="text-sm text-gray-600">Status: ${item.status}</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            <select onchange="updateOrderItemStatus(${order.id}, ${item.id}, this.value)" class="rounded-md border-gray-300 shadow-sm">
                                                <option value="pending" ${item.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="preparing" ${item.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                                <option value="ready" ${item.status === 'ready' ? 'selected' : ''}>Ready</option>
                                                <option value="served" ${item.status === 'served' ? 'selected' : ''}>Served</option>
                                            </select>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading orders:', error);
                alert('Failed to load orders. Please try again.');
            }
        }

        async function updateOrderItemStatus(orderId, itemId, status) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/orders/${orderId}/items/${itemId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status }),
                });

                if (!response.ok) {
                    throw new Error('Failed to update order item status');
                }
                
                loadOrders();
            } catch (error) {
                console.error('Error updating order item status:', error);
                alert('Failed to update order item status. Please try again.');
            }
        }

        async function completeOrder(orderId) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/orders/${orderId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    loadOrders();
                } else {
                    throw new Error('Failed to complete order');
                }
            } catch (error) {
                console.error('Error completing order:', error);
                alert('Failed to complete order. Please try again.');
            }
        }

        // Table Management
        async function generateQRCode(tableId) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/tables/${tableId}/qr-code`);
                const data = await response.json();
                
                const modal = createModal(
                    'Table QR Code',
                    `
                    <div class="text-center">
                        <img src="${data.qr_code_url}" alt="Table QR Code" class="mx-auto mb-4">
                        <p class="text-sm text-gray-600">Scan this QR code to access the table's menu</p>
                        <button onclick="window.print()" class="btn btn-primary mt-4">
                            <i class="fas fa-print mr-2"></i>Print QR Code
                        </button>
                    </div>
                    `
                );
            } catch (error) {
                console.error('Error generating QR code:', error);
                alert('Failed to generate QR code. Please try again.');
            }
        }

        // Statistics
        async function loadOrderStats() {
            try {
                const startDate = document.getElementById('statsStartDate').value;
                const endDate = document.getElementById('statsEndDate').value;
                let url = `${API_BASE_URL}/admin/orders/stats`;
                
                if (startDate || endDate) {
                    url += `?start_date=${startDate}&end_date=${endDate}`;
                }
                
                const response = await fetch(url);
                const stats = await response.json();
                
                document.getElementById('totalOrders').textContent = stats.total_orders;
                document.getElementById('totalRevenue').textContent = `$${stats.total_revenue.toFixed(2)}`;
                document.getElementById('avgOrderValue').textContent = `$${stats.average_order_value.toFixed(2)}`;
                
                // Load top menu items
                const topMenuItemsContainer = document.getElementById('topMenuItems');
                topMenuItemsContainer.innerHTML = stats.top_menu_items.map(item => `
                    <div class="flex justify-between items-center">
                        <span>${item.name}</span>
                        <span class="font-semibold">${item.count} orders</span>
                    </div>
                `).join('');
                
                // Load busiest hours
                const busiestHoursContainer = document.getElementById('busiestHours');
                busiestHoursContainer.innerHTML = stats.busiest_hours.map(hour => `
                    <div class="flex justify-between items-center">
                        <span>${hour.hour}:00 - ${hour.hour + 1}:00</span>
                        <span class="font-semibold">${hour.count} orders</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading order stats:', error);
                alert('Failed to load order statistics. Please try again.');
            }
        }

        // Menu Item Availability
        async function toggleMenuItemAvailability(id, isAvailable) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/menu/${id}/availability`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ is_available: isAvailable }),
                });

                if (response.ok) {
                    loadMenuItems();
                } else {
                    throw new Error('Failed to update menu item availability');
                }
            } catch (error) {
                console.error('Error updating menu item availability:', error);
                alert('Failed to update menu item availability. Please try again.');
            }
        }

        // Authentication
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/auth/check`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    }
                });
                
                if (!response.ok) {
                    window.location.href = '/admin/login.html';
                }
            } catch (error) {
                console.error('Error checking authentication:', error);
                window.location.href = '/admin/login.html';
            }
        }

        async function logout() {
            try {
                await fetch(`${API_BASE_URL}/admin/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    }
                });
                
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login.html';
            } catch (error) {
                console.error('Error logging out:', error);
                alert('Failed to logout. Please try again.');
            }
        }

        // Reservations Management
        async function loadReservations() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/reservations`);
                const reservations = await response.json();
                const container = document.getElementById('reservations-list');
                
                container.innerHTML = reservations.map(reservation => `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-semibold">Reservation #${reservation.id}</h3>
                                <p class="text-gray-600">Table ${reservation.table_id}</p>
                                <p class="text-gray-600">Customer: ${reservation.customer_name}</p>
                                <p class="text-gray-600">Date: ${new Date(reservation.reservation_time).toLocaleString()}</p>
                                <p class="text-gray-600">Party Size: ${reservation.party_size}</p>
                                <p class="text-gray-600">Status: ${reservation.status}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="updateReservationStatus(${reservation.id}, 'confirmed')" class="btn btn-secondary">
                                    Confirm
                                </button>
                                <button onclick="updateReservationStatus(${reservation.id}, 'cancelled')" class="btn btn-danger">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading reservations:', error);
                alert('Failed to load reservations. Please try again.');
            }
        }

        async function showAddReservationModal() {
            try {
                const tablesResponse = await fetch(`${API_BASE_URL}/admin/tables`);
                const tables = await tablesResponse.json();
                
                const modal = createModal(
                    'Add New Reservation',
                    `
                    <form onsubmit="handleAddReservation(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Customer Name</label>
                            <input type="text" name="customer_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Table</label>
                            <select name="table_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                ${tables.map(table => `
                                    <option value="${table.id}">Table ${table.number} (Capacity: ${table.capacity})</option>
                                `).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Reservation Time</label>
                            <input type="datetime-local" name="reservation_time" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Party Size</label>
                            <input type="number" name="party_size" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea name="notes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Add Reservation</button>
                    </form>
                    `
                );
            } catch (error) {
                console.error('Error loading tables:', error);
                alert('Failed to load tables. Please try again.');
            }
        }

        // Admin Users Management
        async function loadAdminUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`);
                const users = await response.json();
                const container = document.getElementById('admin-users-list');
                
                container.innerHTML = users.map(user => `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-semibold">${user.username}</h3>
                                <p class="text-gray-600">Role: ${user.role}</p>
                                <p class="text-gray-600">Last Login: ${new Date(user.last_login).toLocaleString()}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="showEditAdminUserModal(${user.id})" class="btn btn-secondary">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteAdminUser(${user.id})" class="btn btn-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading admin users:', error);
                alert('Failed to load admin users. Please try again.');
            }
        }

        // Real-time Updates
        function setupWebSocket() {
            const ws = new WebSocket(`ws://${window.location.host}/ws/admin`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                switch (data.type) {
                    case 'order_update':
                        loadOrders();
                        break;
                    case 'reservation_update':
                        loadReservations();
                        break;
                    case 'menu_update':
                        loadMenuItems();
                        break;
                }
            };
            
            ws.onclose = () => {
                setTimeout(setupWebSocket, 1000);
            };
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            showSection('menu');
            loadMenuItems();
            loadTables();
            loadToppings();
            loadOrders();
            loadOrderStats();
            loadReservations();
            loadAdminUsers();
            setupWebSocket();
        });
    </script>

    <style>
        .btn {
            @apply px-4 py-2 rounded font-medium transition-colors;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-600 text-white hover:bg-gray-700;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700;
        }
    </style>
</body>
</html> 